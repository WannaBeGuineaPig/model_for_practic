# Диадок 

## Описание 

**Диадок** — это система юридически значимого электронного документооборота. Пользователи сервиса подписывают документы квалифицированной электронной подписью и обмениваются ими с контрагентами без дублирования на бумаге.

![Рисунок](media/article14022022-1.png)

## Настройка работы Диадока

Для интеграции системы с сервисом Диадок необходимо настроить следующие библиотеки:

- Диадок 
- диадок-Сервис 



## Подключение библиотек 

В настройках конфигурации сайта (конфиги) прописываются настройки сервиса Диадок для каждой организации. Прописываются такие параметры как:

- путь 
- логин
- пароль 
- ключ который предоставляется Контур.Диадок при заключении договора организации с диадоком (API-ключ для интеграции с Контур.Диадок)

Ниже приведен скрин с примером:

![Pictures](media/screen-9.png)

## Работа Диадока

Для работы Диадока необходимо настроить задания планировщика:

1. **Загрузка boxid** - это идентификаторы на которые будут отправляться и приниматься контрагенты.
2. **Обновление статусов** - считывает текущие статусы контрагента (принятые, подписанные, аннулированные и т.д).
3. **Загрузка новых событий** - факты подписания документов контрагентов и загрузка файла. 

![Pictures](media/screen-1.png)

Для работы с Диадоком в Лексеме необходимо иметь определенную роль, подробнее можно ознакомиться в разделе [Технические роли](https://ecm-administrator-manuals.readthedocs.io/ru/latest/Admin%20manuals/%D0%A2%D0%B5%D1%85%D0%BD%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B5%20%D1%80%D0%BE%D0%BB%D0%B8/#%D0%BE%D0%BF%D0%B8%D1%81%D0%B0%D0%BD%D0%B8%D0%B5).

В системе имеется 2 формы Диадока: 

**Документы Диадока** - форма документа которая хранит все данные о том что отправляли или принимали по Диадоку.

**Реестр документа Диадока** - аналитическая форма, она необходима для оптимизированной работы документов по Диадоку. 

![Pictures](media/screen-3.png) 

Создание документа Диадока происходит автоматически в процессе отправки документа в Диадок. Система автоматически заполняет всю информацию по документу. 

Имеется 2 вида документов Диадока: 

1. **_Входящие документы_** - формируются по задачи шедулера по проверке новых событий в ящике "Диадок". 
2. **_Исходящие документы_** - формируются из формы документа "Договор" и "Доп. Соглашения" к договору. 

![Pictures](media/screen-2.png)

При отправке договора или доп. соглашения в Диадок, система определяет кем был подписан докумен подписью КЭП и вместе с файлом во вложении отправляется в диадок. Если на сотрудника подписавшего документ, существует действующая МЧД, ЭДО то в диадок отправляется идентификатор доверенности.

После того как договор был подписан, в документ вкладывается скан-файл с типом вложения "Оригинал PDF". На каждое вложение формируется новый документ Диадок. Ему присваивается **Messageid** и **Entityid**.  

??? Информация 
    **_Messageid_** — уникальный идентификатор, который используется для идентификации сообщений.  
    **_Entityid_** - это уникальный идентификатор, который используется для однозначного представления сущности (объекта) в системе или контексте, где она существует. 

    
Чтобы отправить договор в Диадок необходимо по кнопке "Операции" в панели управления выбрать строку "Отправить документ в Диадок". Подробнее о данных строках можно ознакомиться в разделе [Работа Диадока](https://ecm-administrator-manuals.readthedocs.io/ru/latest/Admin%20manuals/%D0%9D%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0%20%D0%94%D0%B8%D0%B0%D0%B4%D0%BE%D0%BA%D0%B0/#%D0%BD%D0%B0%D1%81%D1%82%D1%80%D0%BE%D0%B9%D0%BA%D0%B0_%D0%B8%D0%BD%D1%82%D0%B5%D0%B3%D1%80%D0%B0%D1%86%D0%B8%D0%B8_%D1%81_%D0%B4%D0%B8%D0%B0%D0%B4%D0%BE%D0%BA).

![Pictures](media/screen-4.png) 

После выбора действия "Отправить документ в Диадок" в реестре "Документы Диадок" формируется новый исходящий документ, в котором автоматически заполняются информация: 

- от имени какой организации отправился документ и какой организации отправился (строка идентификатор ящика отправителя)
- с какого ящика диадок отправился и на какой ящик другой организации (строка идентификатор ящика получателя)
- строка с именем файла отправленного с документом (строка файл)

![Pictures](media/screen-6.png)

Так же по кнопке "Перейти" есть возможность перейти в договор или Доп. Соглашение отправленного в Диадок.

![Pictures](media/screen-5.png)
  
## Настройка интеграции с Диадок 

Система автоматически загрузит в раздел "Реквизиты Диадока" реквизиты контрагента по задачам загрузки **boxid**, **Guid** и таблицу с информацией о том с каким юридическим лицом интегрированы по Диадоку. Проще говоря, это те контрагенты которые приняли приглашение для обмена по Диадоку с указанным контрагентом в строке "Идентификатор участника ЭДО".

В карточке контрагента на вкладке "Настройка интеграции с Диадок" указана информация по данному контрагенту в системе Диадока:

![Pictures](media/screen-10.png)

Если необходимо указать инедтификатор участника ЭДО, отличный от того который загружен автоматически, то необходимо заполнить поле "Идентификатора" участника ЭДО. Для редактирования этого поля у пользователя должна быть роль **_responsible_accountant_diadoc_**. 

- **Идентификатор участника ЭДО** - поле с запросом которое выводит реквизиты по контрагенту из Диадока 
- **идентификатор участника ЭДО сверен** - чекбокс признак необходимый для того чтобы другой идентификатор не загружался в систему.


![Pictures](media/screeen.png)
  
Далее необходимо нажать кнопку "Загрузить реквизиты из Диадока". 

![Pictures](media/screen-7.png)

**boxid (ручной ввод)** - заполняется в ручную в случае если необходим для работы с ним один конкретный ящик, а у контрагента имеется разное множество ящиков.

**boxid (загруженный)** - строка которая заполняется автоматически при работе задачи **"Загрузка boxid ящиков Диадок контрагентов"**

![Pictures](media/screen-8.png)


??? Пример "Пример JSON формата данных контрагента"

    ```json
        "OrgIdGuid": "0581-JHY-862",  
                "OrgId": "0581-JHY-8620", --Guid  
                "Inn": "1234567890",  
                "Kpp": "1234567890",  
                "FullName": "Акционерное общество \"Радуга\"",  
                "ShortName": "АО \"Радуга\"",  
                "JoinedDiadocTreaty": true,  
                "Boxes": [  
                {  
                    "BoxId": "111abc654@diadoc.ru",  --boxId  
                    "BoxIdGuid": "111abc-654",  
                    "Title": "АО \"Радуга\"",  
                    "InvoiceFormatVersion": "v5_02",  
                    "EncryptedDocumentsAllowed": false  
                }  
            ],  
                
            "Ogrn": "1234567890",
                        
        "FnsParticipantId": "2BH47rDA", --Идентификатор учатсника ЭДО
    ```

При нажатии на кнопку "Операции" в документе договор или доп. соглашение, имеются две операции:

1. **Отправить в Диадок** - документ направляется в систему Диадока c помощью сервиса API, где его при необходимости возможно отредактировать. 
2. **Отправить в Диадок шаблон** - отправляется шаблон документа который не возможно редактировать. 

В окне "История" в панели управления документа Диадока показывается история документа, например _"Ожидается подпись контрагентом"_, _"Подписан контрагентом"_, _"Аннулирован контрагентом"_ и т.п.

![Рисунок](media/configi.jpg) 

Также во вложении будет файл, который имеет подписание с двух сторон с водяным знаком. 

При каждой новой отправке в Диадок система отправляет те файлы, которые не были отправлены ранее, с последней подписью КЭП.






